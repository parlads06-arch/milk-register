<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Management System - Billing</title>
    <!-- jsPDF + html2canvas + SheetJS (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> <!-- [web:21] -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> <!-- [web:27] -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <!-- [web:26] -->
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:linear-gradient(135deg,#667eea,#764ba2);
            min-height:100vh;
            padding:10px;
        }
        .container{
            max-width:100%;
            width:100%;
            background:#fff;
            border-radius:12px;
            box-shadow:0 10px 30px rgba(0,0,0,0.2);
            overflow:hidden;
        }
        /* LOGIN */
        .login-container{
            display:flex;
            align-items:center;
            justify-content:center;
            min-height:90vh;
            padding:20px;
        }
        .login-form{
            background:#fff;
            padding:25px;
            border-radius:12px;
            box-shadow:0 10px 25px rgba(0,0,0,0.1);
            width:100%;
            max-width:380px;
        }
        .role-selector{
            display:flex;
            gap:8px;
            justify-content:center;
            margin-bottom:20px;
            flex-wrap:wrap;
        }
        .role-btn{
            flex:1;
            min-width:120px;
            padding:10px 16px;
            border:1px solid #ddd;
            border-radius:8px;
            cursor:pointer;
            background:#f8f9fa;
            font-size:14px;
            font-weight:600;
        }
        .role-btn.active{background:#4CAF50;color:#fff;border-color:#4CAF50;}
        .form-group{margin-bottom:15px;}
        label{display:block;margin-bottom:6px;font-weight:600;color:#333;font-size:14px;}
        input{
            width:100%;
            padding:12px;
            border:2px solid #e1e5e9;
            border-radius:8px;
            font-size:15px;
        }
        input:focus{
            outline:none;
            border-color:#4CAF50;
            box-shadow:0 0 0 3px rgba(76,175,80,0.12);
        }
        .btn{
            padding:12px 18px;
            border:none;
            border-radius:8px;
            background:#4CAF50;
            color:#fff;
            font-size:15px;
            font-weight:600;
            cursor:pointer;
            margin-top:6px;
            width:100%;
        }
        .btn:hover{background:#45a049;}
        .btn-secondary{background:#2196F3;}
        .btn-secondary:hover{background:#1976D2;}
        .btn-danger{background:#f44336;}
        .btn-danger:hover{background:#d32f2f;}
        .btn-small{width:auto;font-size:12px;padding:6px 10px;margin:2px;}
        .link-btn{
            background:none;border:none;color:#2196F3;
            cursor:pointer;font-size:13px;text-decoration:underline;padding:0;margin-top:5px;
        }
        /* DASHBOARDS */
        .dashboard{display:none;padding:20px;}
        .header{
            background:linear-gradient(135deg,#4CAF50,#45a049);
            color:#fff;
            padding:15px 20px;
            margin:-20px -20px 20px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            flex-wrap:wrap;
            gap:8px;
        }
        .header h1{font-size:18px;}
        .header small{font-size:12px;opacity:0.9;}
        .logout{
            background:rgba(255,255,255,0.2);
            padding:8px 14px;
            border-radius:20px;
            cursor:pointer;
            font-size:13px;
        }
        .section{
            background:#f8f9fa;
            padding:15px;
            border-radius:10px;
            margin-bottom:15px;
        }
        .section h3{margin-bottom:10px;font-size:16px;color:#333;}
        .flex{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
        .form-row{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
            gap:10px;
            margin-bottom:10px;
        }
        .stats{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
            gap:10px;
            margin-bottom:15px;
        }
        .stat-card{
            background:#fff;
            padding:12px;
            border-radius:8px;
            text-align:center;
            box-shadow:0 3px 10px rgba(0,0,0,0.08);
        }
        .stat-number{font-size:1.4em;font-weight:bold;color:#4CAF50;}
        .two-column{
            display:grid;
            grid-template-columns:1fr;
            gap:15px;
        }
        @media(min-width:900px){
            .two-column{grid-template-columns:2fr 1.2fr;}
        }
        .table-container{
            max-height:260px;
            overflow-y:auto;
            overflow-x:auto;
        }
        table{
            width:100%;
            border-collapse:collapse;
            background:#fff;
            font-size:13px;
        }
        th,td{
            padding:8px 6px;
            border-bottom:1px solid #e1e5e9;
            text-align:left;
        }
        th{
            background:#4CAF50;
            color:#fff;
            font-size:12px;
            position:sticky;top:0;z-index:5;
        }
        tr:hover{background:#f8f9ff;}
        .clickable-name{color:#2196F3;cursor:pointer;text-decoration:underline;font-weight:500;}
        .hidden{display:none !important;}
        /* MOBILE TABLE (card style) */
        @media(max-width:768px){
            table,thead,tbody,th,td,tr{display:block;}
            thead tr{position:absolute;top:-9999px;left:-9999px;}
            tr{
                border:1px solid #ddd;
                margin-bottom:10px;
                border-radius:8px;
                padding:8px;
                background:#fff;
            }
            td{
                border:none;
                position:relative;
                padding-left:40%;
                text-align:right;
                font-size:13px;
            }
            td:before{
                content:attr(data-label);
                position:absolute;
                left:8px;
                width:35%;
                font-weight:600;
                color:#555;
                white-space:nowrap;
            }
        }
        /* BILL AREA */
        #billContainer{
            background:#fff;
            padding:10px;
            border-radius:8px;
            box-shadow:0 3px 10px rgba(0,0,0,0.08);
        }
        #billContainer h3{margin-bottom:5px;}
        #billContainer p{font-size:13px;margin:2px 0;}
        ::-webkit-scrollbar{width:6px;}
        ::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:3px;}
        ::-webkit-scrollbar-track{background:#f1f1f1;}
    </style>
</head>
<body>
<div id="loginScreen" class="container">
    <div class="login-container">
        <div class="login-form">
            <h2 style="text-align:center;margin-bottom:15px;">ðŸ¥› Milk Management</h2>
            <div class="role-selector">
                <button class="role-btn active" onclick="selectRole(event,'admin')">Admin</button>
                <button class="role-btn" onclick="selectRole(event,'customer')">Customer</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label id="roleLabel">Admin Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">Login</button>
            </form>
            <div id="forgotPasswordBox">
                <button class="link-btn" onclick="showAdminReset()">Forgot admin password?</button>
                <div id="adminResetPanel" class="hidden">
                    <small>Secret code: 1234</small>
                    <div class="form-group">
                        <input type="password" id="adminSecret" placeholder="Secret code">
                    </div>
                    <div class="form-group">
                        <input type="password" id="newAdminPass" placeholder="New admin password">
                    </div>
                    <button class="btn btn-secondary" onclick="resetAdminPassword()">Reset Password</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ADMIN DASHBOARD -->
<div id="adminDashboard" class="container dashboard">
    <div class="header">
        <div>
            <h1>Admin Dashboard</h1>
            <small id="todayDate"></small>
        </div>
        <div class="logout" onclick="logout()">Logout</div>
    </div>

    <div class="section">
        <h3>Rate & Search</h3>
        <div class="flex">
            <div style="flex:1;min-width:180px;">
                <label>Milk Rate (â‚¹/L)</label>
                <input type="number" id="milkRate" step="0.01" placeholder="Rate">
                <button class="btn btn-secondary btn-small" onclick="updateMilkRate()">Update</button>
                <span id="currentRate" style="font-weight:600;color:#4CAF50;margin-left:6px;">â‚¹60.00</span>
            </div>
            <div style="flex:1;">
                <label>Search Customer</label>
                <input type="text" id="searchCustomer" placeholder="Name or ID" oninput="filterCustomers()">
            </div>
        </div>
    </div>

    <div class="section">
        <h3>Customer Management</h3>
        <div class="form-row">
            <input type="text" id="newCustomerName" placeholder="Customer name">
            <input type="text" id="newCustomerId" placeholder="Customer ID">
            <input type="password" id="newCustomerPass" placeholder="Password">
            <button class="btn" onclick="addCustomer()">Add Customer</button>
        </div>
        <div class="form-row">
            <input type="text" id="setCustId" placeholder="Customer ID">
            <input type="password" id="setCustPass" placeholder="New password">
            <button class="btn btn-secondary" onclick="setCustomerPassword()">Set / Reset Password</button>
        </div>
    </div>

    <div class="two-column">
        <!-- LEFT: RECORDS TABLE -->
        <div class="section">
            <h3>Records (click name)</h3>
            <div class="table-container">
                <table id="customersTable">
                    <thead>
                    <tr>
                        <th>ID</th><th>Name</th><th>Date</th><th>Qty</th><th>Rate</th><th>Total</th><th>Paid</th><th>Bal</th><th>Act</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- RIGHT: DETAIL + BILL -->
        <div class="section">
            <h3>Customer Detail & Bill</h3>
            <div id="noCustomerSelected">Select a customer name to view.</div>
            <div id="customerDetailPanel" class="hidden">
                <div class="stats">
                    <div class="stat-card"><div class="stat-number" id="selCustName">-</div><div>Name</div></div>
                    <div class="stat-card"><div class="stat-number" id="selCustQty">0 L</div><div>Total Milk</div></div>
                    <div class="stat-card"><div class="stat-number" id="selCustTotal">â‚¹0</div><div>Total Amt</div></div>
                    <div class="stat-card"><div class="stat-number" id="selCustBalance">â‚¹0</div><div>Balance</div></div>
                </div>

                <!-- BILL GENERATION -->
                <div class="section" style="padding:10px;margin-bottom:10px;">
                    <h4 style="margin-bottom:8px;">Generate Bill (by date)</h4>
                    <div class="form-row">
                        <div>
                            <label>Start Date</label>
                            <input type="date" id="billStartDate">
                        </div>
                        <div>
                            <label>End Date</label>
                            <input type="date" id="billEndDate">
                        </div>
                        <div>
                            <label>&nbsp;</label>
                            <button class="btn btn-secondary btn-small" onclick="generateBillForSelected()">Generate</button>
                        </div>
                    </div>
                    <div class="flex">
                        <button class="btn btn-small" onclick="downloadBillPDF('admin')">PDF</button>
                        <button class="btn btn-small btn-secondary" onclick="downloadBillExcel('admin')">Excel</button>
                        <button class="btn btn-small btn-danger" onclick="downloadBillImage('admin')">JPG</button>
                    </div>
                </div>

                <!-- BILL DISPLAY -->
                <div id="billContainer">
                    <h3>Bill</h3>
                    <p>No bill generated yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CUSTOMER DASHBOARD -->
<div id="customerDashboard" class="container dashboard">
    <div class="header">
        <div>
            <h1>Customer Dashboard</h1>
            <small id="custTodayDate"></small>
        </div>
        <div class="logout" onclick="logout()">Logout</div>
    </div>

    <div class="stats">
        <div class="stat-card"><div class="stat-number" id="custMilkQty">0 L</div><div>Total Milk</div></div>
        <div class="stat-card"><div class="stat-number" id="custRate">â‚¹60</div><div>Current Rate</div></div>
        <div class="stat-card"><div class="stat-number" id="custTotal">â‚¹0</div><div>Total Amount</div></div>
        <div class="stat-card"><div class="stat-number" id="custBalance">â‚¹0</div><div>Balance</div></div>
    </div>

    <div class="section">
        <h3>Your Records</h3>
        <div class="table-container">
            <table id="customerRecordsTable">
                <thead>
                <tr><th>Date</th><th>Qty</th><th>Rate</th><th>Total</th><th>Paid</th><th>Bal</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h3>Your Generated Bill</h3>
        <div class="flex" style="margin-bottom:8px;">
            <button class="btn btn-small" onclick="downloadBillPDF('customer')">PDF</button>
            <button class="btn btn-small btn-secondary" onclick="downloadBillExcel('customer')">Excel</button>
            <button class="btn btn-small btn-danger" onclick="downloadBillImage('customer')">JPG</button>
        </div>
        <div id="customerBillContainer">
            <p>No bill generated yet by admin.</p>
        </div>
    </div>
</div>

<script>
    const defaultAdmin = { username:'admin', password:'admin123' };
    const SECRET_CODE = '1234';
    let adminData = JSON.parse(localStorage.getItem('adminData')) || defaultAdmin;

    const demoCustomers = [
        {id:'CUST001',name:'Raj Kumar',password:'1111',records:[
                {date:'2026-01-10',qty:25,rate:60,paid:1200},
                {date:'2026-01-09',qty:20,rate:60,paid:0}
        ]},
        {id:'CUST002',name:'Sunita Devi',password:'2222',records:[
                {date:'2026-01-10',qty:30,rate:60,paid:1500}
        ]}
    ];

    let customers = JSON.parse(localStorage.getItem('customers')) || demoCustomers;
    let milkRate = parseFloat(localStorage.getItem('milkRate')) || 60;
    let currentRole = 'admin';
    let currentUser = null;
    let loggedInCustomerId = null;
    let selectedCustomerIndex = null;
    // last generated bill (for both admin and customer)
    let lastBill = null;

    document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('loginForm').addEventListener('submit',handleLogin);
        updateCurrentRateDisplay();
        renderAdminTable();
        setTodayDates();
    });

    function setTodayDates(){
        const t=new Date();const s=t.toLocaleDateString('en-IN');
        document.getElementById('todayDate').textContent='Today: '+s;
        document.getElementById('custTodayDate').textContent='Today: '+s;
    }

    function selectRole(ev,role){
        currentRole=role;
        document.querySelectorAll('.role-btn').forEach(b=>b.classList.remove('active'));
        ev.target.classList.add('active');
        const label=document.getElementById('roleLabel');
        const u=document.getElementById('username');
        if(role==='admin'){
            label.textContent='Admin Username';
            u.placeholder='Enter admin username';
            document.getElementById('forgotPasswordBox').classList.remove('hidden');
        }else{
            label.textContent='Customer ID';
            u.placeholder='Enter customer ID';
            document.getElementById('forgotPasswordBox').classList.add('hidden');
        }
    }

    function handleLogin(e){
        e.preventDefault();
        const u=document.getElementById('username').value.trim();
        const p=document.getElementById('password').value;
        if(currentRole==='admin'){
            if(u===adminData.username && p===adminData.password){
                currentUser='admin';
                showDashboard('admin');
            }else alert('Invalid admin credentials');
        }else{
            const c=customers.find(x=>x.id.toUpperCase()===u.toUpperCase());
            if(c && c.password===p){
                currentUser=c;
                loggedInCustomerId=c.id;
                showCustomerDashboard(c.id);
            }else alert('Invalid customer ID or password');
        }
    }

    function showDashboard(role){
        document.getElementById('loginScreen').style.display='none';
        document.getElementById('adminDashboard').style.display=role==='admin'?'block':'none';
        document.getElementById('customerDashboard').style.display=role==='customer'?'block':'none';
        if(role==='admin'){renderAdminTable();clearSelectedCustomer();}
    }

    function showCustomerDashboard(id){
        const c=customers.find(x=>x.id===id);
        if(c){
            updateCustomerStats(c);
            renderCustomerRecords(c.records);
            // show last bill if exists
            if(lastBill && lastBill.customerId===id){
                renderBillHTML(lastBill,'customerBillContainer');
            }else{
                document.getElementById('customerBillContainer').innerHTML='<p>No bill generated yet by admin.</p>';
            }
            showDashboard('customer');
        }
    }

    function logout(){
        currentUser=null;loggedInCustomerId=null;selectedCustomerIndex=null;
        document.getElementById('loginScreen').style.display='block';
        document.getElementById('adminDashboard').style.display='none';
        document.getElementById('customerDashboard').style.display='none';
        document.getElementById('loginForm').reset();
    }

    function showAdminReset(){
        document.getElementById('adminResetPanel').classList.toggle('hidden');
    }

    function resetAdminPassword(){
        const s=document.getElementById('adminSecret').value;
        const np=document.getElementById('newAdminPass').value;
        if(s!==SECRET_CODE){alert('Wrong secret code');return;}
        if(!np){alert('Enter new password');return;}
        adminData.password=np;
        localStorage.setItem('adminData',JSON.stringify(adminData));
        alert('Admin password changed');
        document.getElementById('adminSecret').value='';
        document.getElementById('newAdminPass').value='';
        document.getElementById('adminResetPanel').classList.add('hidden');
    }

    function updateMilkRate(){
        const v=parseFloat(document.getElementById('milkRate').value);
        if(!v||v<=0){alert('Enter valid rate');return;}
        milkRate=v;
        localStorage.setItem('milkRate',milkRate.toString());
        updateCurrentRateDisplay();
        renderAdminTable();
        alert('Milk rate updated');
    }

    function updateCurrentRateDisplay(){
        document.getElementById('currentRate').textContent='â‚¹'+milkRate.toFixed(2);
        document.getElementById('custRate').textContent='â‚¹'+milkRate.toFixed(2);
    }

    function addCustomer(){
        const name=document.getElementById('newCustomerName').value.trim();
        const id=document.getElementById('newCustomerId').value.trim().toUpperCase();
        const pass=document.getElementById('newCustomerPass').value;
        if(!name||!id||!pass){alert('Fill all fields');return;}
        if(customers.find(c=>c.id===id)){alert('ID already exists');return;}
        const today=new Date().toISOString().split('T')[0];
        customers.push({id,name,password:pass,records:[{date:today,qty:0,rate:milkRate,paid:0}]});
        saveCustomers();renderAdminTable();
        document.getElementById('newCustomerName').value='';
        document.getElementById('newCustomerId').value='';
        document.getElementById('newCustomerPass').value='';
        alert('Customer added');
    }

    function setCustomerPassword(){
        const id=document.getElementById('setCustId').value.trim().toUpperCase();
        const pass=document.getElementById('setCustPass').value;
        if(!id||!pass){alert('Enter ID and password');return;}
        const c=customers.find(x=>x.id===id);
        if(!c){alert('Customer not found');return;}
        c.password=pass;saveCustomers();alert('Password updated');
    }

    function renderAdminTable(){
        const tbody=document.querySelector('#customersTable tbody');
        tbody.innerHTML='';
        customers.forEach((c,ci)=>{
            c.records.forEach((r,ri)=>{
                const total=r.qty*r.rate;
                const bal=total-r.paid;
                const row=tbody.insertRow();
                row.innerHTML=`
<td data-label="ID">${c.id}</td>
<td data-label="Name"><span class="clickable-name" onclick="showFullCustomer(${ci})">${c.name}</span></td>
<td data-label="Date">${r.date}</td>
<td data-label="Qty"><input type="number" value="${r.qty}" min="0" step="0.1" style="width:70px;" onchange="updateQty(${ci},${ri},this.value)"></td>
<td data-label="Rate">â‚¹${r.rate.toFixed(2)}</td>
<td data-label="Total">â‚¹${total.toFixed(2)}</td>
<td data-label="Paid"><input type="number" value="${r.paid}" min="0" step="0.01" style="width:70px;" onchange="updatePaid(${ci},${ri},this.value)"></td>
<td data-label="Bal">â‚¹${bal.toFixed(2)}</td>
<td data-label="Act">
<button class="btn btn-secondary btn-small" onclick="addRecord(${ci})">+</button>
<button class="btn btn-danger btn-small" onclick="deleteRecord(${ci},${ri})">X</button>
</td>`;
            });
        });
        filterCustomers();
    }

    function updateQty(ci,ri,val){
        customers[ci].records[ri].qty=parseFloat(val)||0;
        saveCustomers();renderAdminTable();
        if(selectedCustomerIndex===ci)showFullCustomer(ci);
    }
    function updatePaid(ci,ri,val){
        customers[ci].records[ri].paid=parseFloat(val)||0;
        saveCustomers();renderAdminTable();
        if(selectedCustomerIndex===ci)showFullCustomer(ci);
    }
    function addRecord(ci){
        const today=new Date().toISOString().split('T')[0];
        customers[ci].records.push({date:today,qty:0,rate:milkRate,paid:0});
        saveCustomers();renderAdminTable();
        if(selectedCustomerIndex===ci)showFullCustomer(ci);
    }
    function deleteRecord(ci,ri){
        if(!confirm('Delete record?'))return;
        customers[ci].records.splice(ri,1);
        if(customers[ci].records.length===0){customers.splice(ci,1);selectedCustomerIndex=null;clearSelectedCustomer();}
        saveCustomers();renderAdminTable();
    }

    function filterCustomers(){
        const term=document.getElementById('searchCustomer').value.trim().toUpperCase();
        const rows=document.querySelectorAll('#customersTable tbody tr');
        rows.forEach(r=>{
            const tds=r.querySelectorAll('td');
            if(tds.length<2)return;
            const id=tds[0].innerText.toUpperCase();
            const name=tds[1].innerText.toUpperCase();
            r.style.display=(id.includes(term)||name.includes(term))?'':'none';
        });
    }

    function showFullCustomer(ci){
        selectedCustomerIndex=ci;
        const c=customers[ci];
        document.getElementById('noCustomerSelected').classList.add('hidden');
        document.getElementById('customerDetailPanel').classList.remove('hidden');
        let tq=0,ta=0,tp=0;
        c.records.forEach(r=>{tq+=r.qty;ta+=r.qty*r.rate;tp+=r.paid;});
        document.getElementById('selCustName').textContent=c.name;
        document.getElementById('selCustQty').textContent=tq.toFixed(1)+' L';
        document.getElementById('selCustTotal').textContent='â‚¹'+ta.toFixed(2);
        document.getElementById('selCustBalance').textContent='â‚¹'+(ta-tp).toFixed(2);
    }
    function clearSelectedCustomer(){
        document.getElementById('customerDetailPanel').classList.add('hidden');
        document.getElementById('noCustomerSelected').classList.remove('hidden');
    }

    function updateCustomerStats(c){
        let tq=0,ta=0,tp=0;
        c.records.forEach(r=>{tq+=r.qty;ta+=r.qty*r.rate;tp+=r.paid;});
        document.getElementById('custMilkQty').textContent=tq.toFixed(1)+' L';
        document.getElementById('custTotal').textContent='â‚¹'+ta.toFixed(2);
        document.getElementById('custBalance').textContent='â‚¹'+(ta-tp).toFixed(2);
    }
    function renderCustomerRecords(records){
        const tbody=document.querySelector('#customerRecordsTable tbody');
        tbody.innerHTML='';
        records.forEach(r=>{
            const t=r.qty*r.rate;const b=t-r.paid;
            const row=tbody.insertRow();
            row.innerHTML=`
<td data-label="Date">${r.date}</td>
<td data-label="Qty">${r.qty}</td>
<td data-label="Rate">â‚¹${r.rate.toFixed(2)}</td>
<td data-label="Total">â‚¹${t.toFixed(2)}</td>
<td data-label="Paid">â‚¹${r.paid.toFixed(2)}</td>
<td data-label="Bal">â‚¹${b.toFixed(2)}</td>`;
        });
    }
    function saveCustomers(){localStorage.setItem('customers',JSON.stringify(customers));}

    // ---------- BILL GENERATION ----------
    function generateBillForSelected(){
        if(selectedCustomerIndex===null){alert('Select customer first');return;}
        const c=customers[selectedCustomerIndex];
        const sd=document.getElementById('billStartDate').value;
        const ed=document.getElementById('billEndDate').value;
        if(!sd||!ed){alert('Select start and end date');return;}
        const sDate=new Date(sd), eDate=new Date(ed);
        if(sDate>eDate){alert('Start date should be <= end date');return;}

        const filtered=c.records.filter(r=>{
            const d=new Date(r.date);
            return d>=sDate && d<=eDate;
        });
        if(filtered.length===0){
            alert('No records in this date range');
        }

        let tq=0,ta=0,tp=0;
        filtered.forEach(r=>{tq+=r.qty;ta+=r.qty*r.rate;tp+=r.paid;});
        const balance=ta-tp;

        lastBill={
            customerId:c.id,
            customerName:c.name,
            startDate:sd,
            endDate:ed,
            records:filtered,
            totalQty:tq,
            totalAmount:ta,
            totalPaid:tp,
            balance:balance
        };

        renderBillHTML(lastBill,'billContainer');
        // also update customer view if that customer is logged in
        if(currentUser && currentUser.id===c.id){
            renderBillHTML(lastBill,'customerBillContainer');
        }
    }

    function renderBillHTML(bill,containerId){
        const div=document.getElementById(containerId);
        if(!bill || bill.records.length===0){
            div.innerHTML='<p>No bill generated.</p>';return;
        }
        let rows='';
        bill.records.forEach(r=>{
            const t=r.qty*r.rate;const bal=t-r.paid;
            rows+=`<tr>
<td>${r.date}</td>
<td>${r.qty}</td>
<td>â‚¹${r.rate.toFixed(2)}</td>
<td>â‚¹${t.toFixed(2)}</td>
<td>â‚¹${r.paid.toFixed(2)}</td>
<td>â‚¹${bal.toFixed(2)}</td>
</tr>`;
        });
        div.innerHTML=`
<h3>Milk Bill</h3>
<p><strong>Customer:</strong> ${bill.customerName} (${bill.customerId})</p>
<p><strong>Duration:</strong> ${bill.startDate} to ${bill.endDate}</p>
<table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:12px;">
<thead><tr style="background:#eee;">
<th style="border:1px solid #ccc;padding:4px;">Date</th>
<th style="border:1px solid #ccc;padding:4px;">Qty</th>
<th style="border:1px solid #ccc;padding:4px;">Rate</th>
<th style="border:1px solid #ccc;padding:4px;">Total</th>
<th style="border:1px solid #ccc;padding:4px;">Paid</th>
<th style="border:1px solid #ccc;padding:4px;">Balance</th>
</tr></thead>
<tbody>${rows}</tbody></table>
<p style="margin-top:6px;"><strong>Total Qty:</strong> ${bill.totalQty.toFixed(1)} L</p>
<p><strong>Total Amount:</strong> â‚¹${bill.totalAmount.toFixed(2)}</p>
<p><strong>Total Paid:</strong> â‚¹${bill.totalPaid.toFixed(2)}</p>
<p><strong>Balance:</strong> â‚¹${bill.balance.toFixed(2)}</p>`;
    }

    // ---------- DOWNLOAD: PDF / IMAGE / EXCEL ----------
    async function downloadBillPDF(role){
        if(!lastBill){alert('No bill to download');return;}
        const elementId = role==='admin' ? 'billContainer' : 'customerBillContainer';
        const element=document.getElementById(elementId);
        const { jsPDF } = window.jspdf; // [web:21]
        const canvas=await html2canvas(element); // [web:21][web:27]
        const imgData=canvas.toDataURL('image/png');
        const pdf=new jsPDF('p','mm','a4');
        const pageWidth=pdf.internal.pageSize.getWidth();
        const pageHeight=pdf.internal.pageSize.getHeight();
        const imgProps=pdf.getImageProperties(imgData);
        const ratio=imgProps.height/imgProps.width;
        const imgHeight=pageWidth*ratio;
        pdf.addImage(imgData,'PNG',0,0,pageWidth,imgHeight);
        pdf.save(`bill_${lastBill.customerId}_${lastBill.startDate}_${lastBill.endDate}.pdf`);
    }

    async function downloadBillImage(role){
        if(!lastBill){alert('No bill to download');return;}
        const elementId = role==='admin' ? 'billContainer' : 'customerBillContainer';
        const element=document.getElementById(elementId);
        const canvas=await html2canvas(element); // [web:27]
        const link=document.createElement('a');
        link.href=canvas.toDataURL('image/jpeg');
        link.download=`bill_${lastBill.customerId}_${lastBill.startDate}_${lastBill.endDate}.jpg`;
        link.click();
    }

    function downloadBillExcel(role){
        if(!lastBill){alert('No bill to download');return;}
        const data = lastBill.records.map(r=>{
            const total=r.qty*r.rate;const bal=total-r.paid;
            return {
                Date:r.date,
                Quantity:r.qty,
                Rate:r.rate,
                Total:total,
                Paid:r.paid,
                Balance:bal
            };
        });
        // add totals row
        data.push({
            Date:'TOTAL',
            Quantity:lastBill.totalQty,
            Rate:'',
            Total:lastBill.totalAmount,
            Paid:lastBill.totalPaid,
            Balance:lastBill.balance
        });
        const ws=XLSX.utils.json_to_sheet(data); // [web:26]
        const wb=XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb,ws,'Bill');
        XLSX.writeFile(wb,`bill_${lastBill.customerId}_${lastBill.startDate}_${lastBill.endDate}.xlsx`);
    }
</script>
</body>
</html>
